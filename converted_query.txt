-- Common Table Expressions for frequently used subqueries
WITH CurrentApprover AS (
    SELECT DISTINCT
        {Approval}.[RequisitionId] AS RequisitionId
    FROM {Approval}
    LEFT JOIN {Delegation} ON 
        {Approval}.[AssignedUserId] = {Delegation}.[AbsentApprover] AND 
        {Delegation}.[StartDate] <= @CurrDate AND
        {Delegation}.[EndDate] >= @CurrDate AND 
        {Delegation}.[Is_Active] IS TRUE
    INNER JOIN (
        SELECT 
            {Approval}.[RequisitionId] AS ApprRequisitionId, 
            MIN({Approval}.[Level]) AS ApprMinLevel
        FROM {Approval}
        WHERE {Approval}.[ApprovalStatusId] = @ApprovalStatusId_PendingApproval
        GROUP BY {Approval}.[RequisitionId]
    ) AS ApprovalMinLevel ON 
        {Approval}.[RequisitionId] = ApprovalMinLevel.ApprRequisitionId AND 
        {Approval}.[Level] = ApprovalMinLevel.ApprMinLevel
    WHERE 
        {Approval}.[ApprovalStatusId] = @ApprovalStatusId_PendingApproval AND
        (
            @HasApprovalFilter IS TRUE AND 
            (
                {Delegation}.[SubstituteApprover] = ANY(ARRAY[@FilterApprovalList]) OR 
                {Approval}.[AssignedUserId] = ANY(ARRAY[@FilterApprovalList])
            )
        )
),

UserPurchasingGroups AS (
    SELECT DISTINCT 
        {PurchasingGroups}.[Id] AS PurchasingGroupId
    FROM {PurchasingGroups}
    LEFT JOIN {PurchasingGroupManager} ON 
        {PurchasingGroups}.[Id] = {PurchasingGroupManager}.[PurchasingGroupId] AND 
        {PurchasingGroupManager}.[IsActive] IS TRUE 
    LEFT JOIN {PurchasingGroupResponsible} ON 
        {PurchasingGroups}.[Id] = {PurchasingGroupResponsible}.[PurchasingGroupId] AND 
        {PurchasingGroupResponsible}.[IsActive] IS TRUE 
    WHERE 
        {PurchasingGroupManager}.[PurchasingGroupManager] = @CurrUserId OR
        {PurchasingGroupResponsible}.[PurchasingGroupResponsible] = @CurrUserId             
),

UserRequisitionApprover AS (
    SELECT DISTINCT
        {Approval}.[RequisitionId] AS RequisitionId
    FROM {Approval}
    LEFT JOIN {Delegation} ON 
        {Approval}.[AssignedUserId] = {Delegation}.[AbsentApprover] AND
        {Delegation}.[StartDate] <= @CurrDate AND
        {Delegation}.[EndDate] >= @CurrDate
    WHERE 
        (
            {Approval}.[AssignedUserId] = @CurrUserId OR
            {Approval}.[CompletedBy] = @CurrUserId OR
            (
                {Delegation}.[SubstituteApprover] = @CurrUserId AND
                {Delegation}.[Is_Active] IS TRUE
            )
        )
)

SELECT DISTINCT
    {Requisition}.[Id] AS RequisitionId,
    {Requisition}.[RequisitionNumber] AS RequisitionNumber,
    {Requisition}.[RequisitionName] AS RequisitionName,
    {Requisition}.[RequisitionStatusId] AS StatusId,
    Status.[Label] AS StatusLabel,
    Status.[StatusColor] AS StatusColor,
    {Requisition}.[CurrencyId] AS Currency,
    Currency.[ExternalId] AS CurrencyCode,
    {Requisition}.[TotalValue] AS TotalValue,
    {CostCenter}.[ExternalId] AS CostCenter,
    InternalOrder_Project.[OrderNumber] AS Project,
    {Requisition}.[RequesterId] AS Requester,
    Requester.[Username] AS RequesterUserName,
    {Requisition}.[CreatedAt] AS CreatedAt,
    CASE 
        WHEN {Requisition}.[RequisitionStatusId] = @RejectedStatusId THEN
            COALESCE((
        SELECT STRING_AGG(CASE 
                            WHEN {Order_RejectionReason}.[RejectionReasonId] = @OtherRejectionReason 
                            THEN {ApprovalFlow}.[RejectionReasonDescription]
                            ELSE {RejectionReason}.[Label]
                        END, '|')
        FROM {Order_RejectionReason}
                    INNER JOIN {RejectionReason} ON {RejectionReason}.[Id] = {Order_RejectionReason}.[RejectionReasonId]
                    INNER JOIN {ApprovalFlow} ON {ApprovalFlow}.[RequisitionId] = {Requisition}.[Id]
                    WHERE {Order_RejectionReason}.[RequisitionId] = {Requisition}.[Id]
                    
      ), '') 
        ELSE '' 
    END AS RejectionMotive,
    0 AS IsDetailOpen

FROM {Requisition}

LEFT JOIN {Currency} Currency ON Currency.[Id] = {Requisition}.[CurrencyId] AND Currency.[Language] = @SAPLanguageCode
LEFT JOIN {User} Requester ON Requester.[Id] = {Requisition}.[RequesterId] 
LEFT JOIN {RequisitionStatus} Status ON Status.[Id] = {Requisition}.[RequisitionStatusId]
LEFT JOIN {CostCenter} ON {Requisition}.[CostCenterId] = {CostCenter}.[Id]
LEFT JOIN {InternalOrder} InternalOrder_Project ON {Requisition}.[ProjectId] = InternalOrder_Project.[Id]
LEFT JOIN {RequisitionArticle} AS Article ON {Requisition}.[Id] = Article.[RequisitionId]

/* CTEs JOINS */
LEFT JOIN CurrentApprover ON {Requisition}.[Id] = CurrentApprover.RequisitionId
LEFT JOIN UserRequisitionApprover ON {Requisition}.[Id] = UserRequisitionApprover.RequisitionId
LEFT JOIN UserPurchasingGroups ON Article.[PurchasingGroupId] = UserPurchasingGroups.PurchasingGroupId

WHERE    
    {Requisition}.[IsDeleted] IS FALSE AND
    Status.[Id] <> @DraftStatusId AND 
    (
        @SearchKeyword = '' OR 
        (
            caseaccent_normalize({Requisition}.[RequisitionNumber] collate "default") LIKE caseaccent_normalize('%' || @SearchKeyword || '%') OR
            caseaccent_normalize({Requisition}.[RequisitionName] collate "default") LIKE caseaccent_normalize('%' || @SearchKeyword || '%') OR
            caseaccent_normalize(Requester.[Name] collate "default") LIKE caseaccent_normalize('%' || @SearchKeyword || '%') OR
            caseaccent_normalize(Requester.[Username] collate "default") LIKE caseaccent_normalize('%' || @SearchKeyword || '%') OR 
            caseaccent_normalize(InternalOrder_Project.[OrderNumber] collate "default") LIKE caseaccent_normalize('%' || @SearchKeyword || '%') OR
            caseaccent_normalize({CostCenter}.[ExternalId] collate "default") LIKE caseaccent_normalize('%' || @SearchKeyword || '%') 
        )
    ) AND
    (
        (@HasStatusFilter IS FALSE OR Status.[Id] = ANY(ARRAY[@FilterStatusList])) AND 
        (@HasSupplierFilter IS FALSE OR Article.[SupplierId] = ANY(ARRAY[@FilterSupplierList])) AND 
        (@HasCostCenterFilter IS FALSE OR {Requisition}.[CostCenterId] = ANY(ARRAY[@FilterCostCenterList])) AND 
        (@HasProjectFilter IS FALSE OR {Requisition}.[ProjectId] = ANY(ARRAY[@FilterProjectList])) AND 
        (@HasCurrencyFilter IS FALSE OR {Requisition}.[CurrencyId] = ANY(ARRAY[@FilterCurrencyList])) AND 
        (@FilterMinTotalValueFilter <= {Requisition}.[TotalValue]) AND 
        (@FilterMaxTotalValueFilter >= {Requisition}.[TotalValue]) AND 
        (@HasApprovalFilter IS FALSE OR CurrentApprover.RequisitionId IS NOT NULL) AND
        (
            @FilterCreatedAtStart = @NullDate OR @FilterCreatedAtEnd = @NullDate OR
            (CONVERT(DATE,{Requisition}.[CreatedAt]) >= @FilterCreatedAtStart AND CONVERT(DATE,{Requisition}.[CreatedAt]) <= @FilterCreatedAtEnd)            
        )
    ) AND
    (
        @HasTotalAccess IS TRUE OR {Requisition}.[RequesterId] = @CurrUserId OR {Requisition}.[CreatedBy] = @CurrUserId
        OR UserPurchasingGroups.PurchasingGroupId IS NOT NULL
        OR UserRequisitionApprover.RequisitionId IS NOT NULL
    )
    
ORDER BY @SortForSQL
OFFSET @StartIndex ROWS FETCH NEXT @MaxRecords ROWS ONLY